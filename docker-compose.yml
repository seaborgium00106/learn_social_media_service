# Full Stack Social Network Application - Docker Compose Orchestration
#
# Architecture:
#   - Frontend (Port 3000): React/Vite application
#   - NGINX (Port 80): Load balancer distributing traffic across backend instances
#   - Backend Instances (3): Running on port 9090 internally, exposed on 9091-9093
#   - PostgreSQL (Port 5432): Database
#
# Access Points:
#   - Frontend: http://localhost:3000
#   - API via NGINX: http://localhost (recommended)
#   - Direct Backend 1: http://localhost:9091
#   - Direct Backend 2: http://localhost:9092
#   - Direct Backend 3: http://localhost:9093
#   - Database: localhost:5432
#
# Environment Variables: See .env.example
#
# Development Mode: docker-compose up
# Production Mode: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: postdb_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-postdb}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres123}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d  # Optional: for init scripts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-postdb}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-network

  # NGINX Load Balancer
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: postdb_nginx
    restart: unless-stopped
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/nginx-health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - backend-network

  # Spring Boot Backend Instance 1
  backend-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: postdb_backend_1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_NAME: ${DB_NAME:-postdb}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres123}
      SERVER_PORT: 9090
    ports:
      - "9091:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/api/v1/users || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - backend-network

  # Spring Boot Backend Instance 2
  backend-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: postdb_backend_2
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_NAME: ${DB_NAME:-postdb}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres123}
      SERVER_PORT: 9090
    ports:
      - "9092:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/api/v1/users || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - backend-network

  # React/Vite Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development  # Use 'production' for production builds
    container_name: postdb_frontend
    restart: unless-stopped
    environment:
      # API Configuration
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost}
      VITE_API_TIMEOUT: ${VITE_API_TIMEOUT:-10000}
      # App Configuration
      VITE_APP_NAME: ${VITE_APP_NAME:-Social Network}
      VITE_DEFAULT_PAGE_SIZE: ${VITE_DEFAULT_PAGE_SIZE:-10}
      # HMR Configuration for Docker
      VITE_HMR_HOST: ${VITE_HMR_HOST:-localhost}
      VITE_HMR_PORT: ${VITE_HMR_PORT:-3000}
      VITE_HMR_PROTOCOL: ${VITE_HMR_PROTOCOL:-http}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      # Mount source code for hot reload in development
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json
      # Prevent node_modules from being overwritten
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - backend-network

  # Spring Boot Backend Instance 3
  backend-3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: postdb_backend_3
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_NAME: ${DB_NAME:-postdb}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres123}
      SERVER_PORT: 9090
    ports:
      - "9093:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/api/v1/users || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - backend-network

volumes:
  postgres_data:
    driver: local

networks:
  backend-network:
    driver: bridge
